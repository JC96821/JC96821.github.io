---
title: å‰ç«¯è·¯ç”±åŸç†
date: 2022-01-19
tags:
  - router
  - hash router
  - history router
---

## hashè·¯ç”±åŸç†

> hash æ¨¡å¼æ˜¯ä¸€ç§æŠŠå‰ç«¯è·¯ç”±çš„è·¯å¾„ç”¨äº•å· # æ‹¼æ¥åœ¨çœŸå® url åé¢çš„æ¨¡å¼ã€‚å½“äº•å· # åé¢çš„è·¯å¾„å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæµè§ˆå™¨å¹¶ä¸ä¼šé‡æ–°å‘èµ·è¯·æ±‚ï¼Œè€Œæ˜¯ä¼šè§¦å‘ onhashchange äº‹ä»¶ã€‚

```vue
<ul>
    <li><a href="#/home">home</a></li>
    <li><a href="#/list">list</a></li>
    <li><a href="#/page1">page1</a></li>
    <li><a href="#/page2">page2</a></li>
    <li><a href="#/unknown">unknown</a></li>
</ul>
<button onclick="router.push('/page2')">push</button>
<button onclick="router.go(-1)">back</button>
<button onclick="router.replace('/page1')">replace</button>
<div id="app"></div>

<script>
    // hashè·¯ç”±å¯¹è±¡
    class HashRouter {
        /**
         * æ¥æ”¶ä¸¤ä¸ªå‚æ•°
         * @params el pageé¡µé¢ç»‘å®šçš„domå±æ€§
         * @params routes è·¯ç”±é…ç½®é¡¹
        */
        constructor(options) {
            const { el, routes } = options;
            this.$el = document.querySelector(el);
            this.$routes = routes
            this.bindEvent();
        }
        // ç›‘å¬hashchangeäº‹ä»¶,ç”¨æ¥åŒ¹é…é¡µé¢hashå‚æ•°ä¸é…ç½®é¡¹ï¼ŒåŠ¨æ€æ›´æ–°pageé¡µé¢
        bindEvent() {
            const that = this;
            window.addEventListener('hashchange', e => {
                const path = that.getUrl();
                const route = that.matchRoute(path);
                that.render(route);
            });
        }
        // è·å–å½“å‰hashå‚æ•°ï¼Œå¹¶æ ¼å¼åŒ–ä¸ºæ ‡å‡†pathæ ¼å¼
        getUrl() {
            const hash = window.location.hash;
            const [_front, params] = hash.split('#');
            const path = params.startsWith('/') ? params : `/${params}`;
            return path;
        }
        // åŒ¹é…hashå‚æ•°ä¸è·¯ç”±é…ç½®é¡¹ï¼Œè·å–åŒ¹é…åˆ°çš„é…ç½®é¡¹
        matchRoute(path) {
            const route = this.$routes.find(route => route.path === path);
            const notFound = this.$routes.find(route => route.path === '*');
            return route || notFound;
        }
        // åŠ¨æ€æ¸²æŸ“æ–¹æ³•
        render(route) {
            const { component } = route;
            this.$el.innerHTML = component;
        }
        // è·³è½¬é¡µé¢ï¼Œå¹¶å‘historyä¸­æ·»åŠ ä¸€æ¡è®°å½•ï¼Œgo(-1)æ—¶ä¼šè¿”å›
        push(path) {
            window.location.hash = path;
        }
        // å½“å‰é¡µé¢å‘å‰å‘åè·³è½¬å¤šå°‘ä¸ªé¡µé¢
        go(n) {
            window.history.go(n);
        }
        // è·³è½¬é¡µé¢ï¼Œä½†æ˜¯ä¸å‘historyä¸­æ·»åŠ è®°å½•
        replace(path) {
            const href = window.location.href;
            const [base, hash] = href.split('#');
            window.location.replace(`${base}#${path}`);
        }
    }

    // æ¨¡æ‹Ÿä½¿ç”¨åœºæ™¯ğŸ‘Œ
    const routes = [
        {
            path: '/home',
            component: 'home'
        },
        {
            path: '/list',
            component: 'list'
        },
        {
            path: '/page1',
            component: 'page1'
        },
        {
            path: '/page2',
            component: 'page2'
        },
        {
            path: '*',
            component: '404'
        }
    ];
    const router = new HashRouter({
        el: '#app',
        routes
    });
</script>
```

## historyè·¯ç”±åŸç†
> history API æ˜¯ H5 æä¾›çš„æ–°ç‰¹æ€§ï¼Œå…è®¸å¼€å‘è€…ç›´æ¥æ›´æ”¹å‰ç«¯è·¯ç”±ï¼Œå³æ›´æ–°æµè§ˆå™¨ URL åœ°å€è€Œä¸é‡æ–°å‘èµ·è¯·æ±‚ã€‚ä¸»è¦çš„ API æœ‰ä»¥ä¸‹ä¸¤ä¸ªï¼š`history.pushState(state, title, path)` å’Œ` history.repalceState(state, title, path)`ã€‚

```html
<ul>
    <li><a href="/page1">page1</a></li>
    <li><a href="/page2">page2</a></li>
    <li><a href="/page3">page3</a></li>
    <li><a href="/page4">page4</a></li>
    <li><a href="/unknown">unknown</a></li>
</ul>
<button onclick="router.push(`/page${index++}`)">push</button>
<button onclick="router.go(-1)">back</button>
<button onclick="router.replace('/page1')">replace</button>
<div id="app"></div>

<script>
    // historyè·¯ç”±å¯¹è±¡
    class HistoryRouter{
        /**
         * æ¥æ”¶ä¸¤ä¸ªå‚æ•°
         * @params el pageé¡µé¢ç»‘å®šçš„domå±æ€§
         * @params routes è·¯ç”±é…ç½®é¡¹
        */
        constructor(options){
            const {el, routes} = options;
            this.$el = document.querySelector(el);
            this.$routes = routes;
            this.bindEvent();
            this.hanlder('/page1');
        }
        /**
         * ç›‘å¬popstateäº‹ä»¶ï¼Œå¹¶è§¦å‘æ¸²æŸ“
         * æ³¨æ„: popstateäº‹ä»¶åªæœ‰åœ¨æµè§ˆå™¨äº‹ä»¶/è„šæœ¬è°ƒç”¨back,goæ–¹æ³•æ—¶èµ·æ•ˆ
         *      æ„å‘³ç€ä»£ç†äº‹ä»¶éœ€è¦æ‰‹åŠ¨è§¦å‘æ¸²æŸ“
        */
        bindEvent() {
            const that = this;
            window.addEventListener('popstate', e => {
                const path = window.location.pathname;
                that.hanlder(path);
            });
        }
        // åŒ¹é…hashå‚æ•°ä¸è·¯ç”±é…ç½®é¡¹ï¼Œè·å–åŒ¹é…åˆ°çš„é…ç½®é¡¹
        matchRoute(path) {
            const route = this.$routes.find(route => route.path === path);
            const notFound = this.$routes.find(route => route.path === '*');
            return route || notFound;
        }
        // åŠ¨æ€æ¸²æŸ“æ–¹æ³•
        render(route) {
            const { component } = route;
            this.$el.innerHTML = component;
        }
        // æ¸²æŸ“å‡½æ•°ï¼Œè‡ªåŠ¨åŒ¹é…åœ°å€ä¸æ¸²æŸ“ï¼Œæ–¹ä¾¿å¤„ç†
        hanlder(path) {
            const route = this.matchRoute(path);
            this.render(route);
        }
        /**
         * è·³è½¬é¡µé¢ï¼Œå¹¶å‘historyä¸­æ·»åŠ ä¸€æ¡è®°å½•ï¼Œgo(-1)æ—¶ä¼šè¿”å›
         * åˆ©ç”¨äº†pushstate api
        */
        push(path) {
            history.pushState(null, null, path);
            this.hanlder(path);
        }
        // å½“å‰é¡µé¢å‘å‰å‘åè·³è½¬å¤šå°‘ä¸ªé¡µé¢
        go(n) {
            history.go(n);
        }
        /**
         * è·³è½¬é¡µé¢ï¼Œä½†æ˜¯ä¸å‘historyä¸­æ·»åŠ è®°å½•
         * åˆ©ç”¨äº†replaceState api
        */
        replace(path) {
            history.replaceState(null, null, path);
            this.hanlder(path);
        }
    }
    const routes = [
        {
            path: '/page1',
            component: 'page1'
        },
        {
            path: '/page2',
            component: 'page2'
        },
        {
            path: '/page3',
            component: 'page3'
        },
        {
            path: '/page4',
            component: 'page4'
        },
        {
            path: '*',
            component: '404'
        }
    ];
    var index = 1;
    const router = new HistoryRouter({
        el: '#app',
        routes
    });
</script>
```