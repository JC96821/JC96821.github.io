---
title: promiseåŽŸç†
date: 2022-01-05
tags:
  - promise
  - JavaScript
---

### promiseå®žçŽ°åŽŸç†

```javascript
class MyPromise {
    /**
     * å®šä¹‰äº†ä¸‰ç§çŠ¶æ€
     * @params PENDING ç­‰å¾…ä¸­
     * @params REJECT å‘ç”Ÿäº†å¼‚å¸¸
     * @params FULFILED æ‰§è¡Œå®Œæ¯•
    */
    PENDING = Symbol('PENDING');
    REJECT = Symbol('REJECT');
    FULFIELD = Symbol('FULFIELD');

    /**
     * æž„é€ å‡½æ•°ï¼ŒæŽ¥å—ä¸€ä¸ªå‡½æ•°å‚æ•°
     * @params exector æ‰§è¡Œå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¹ŸæŽ¥å—ä¸¤ä¸ªå‚æ•° resolveã€reject
    */
    constructor(exector) {
        this.status = this.PENDING; // å½“å‰æ‰§è¡ŒçŠ¶æ€
        this.value = null; // resolveçš„å€¼
        this.reason = null; // rejectçš„å€¼
        this.resolveTaskList = []; // è®¢é˜…çš„resolveäº‹ä»¶åˆ—è¡¨ï¼Œæ‰§è¡ŒæˆåŠŸæ—¶æ‰¹é‡æ‰§è¡Œ
        this.reasonTaskList = []; // è®¢é˜…çš„rejectäº‹ä»¶åˆ—è¡¨ï¼Œæ‰§è¡Œå¤±è´¥æ—¶æ‰¹é‡æ‰§è¡Œ
        
        /**
         * resolveå‡½æ•°
         * @params value æ‰‹åŠ¨resolveçš„å€¼
         * @description æ‰¹é‡æ‰§è¡Œè®¢é˜…çš„åˆ—è¡¨
        */
        const resolve = value => {
            this.status = this.FULFIELD;
            this.value = value;
            this.resolveTaskList.forEach(task => task());
        };

        /**
         * rejectå‡½æ•°
         * @params reason æ‰‹åŠ¨rejectçš„å€¼
         * @description æ‰¹é‡æ‰§è¡Œè®¢é˜…çš„åˆ—è¡¨
        */
        const reject = reason => {
            this.status = this.REJECT;
            this.reason = reason;
            this.reasonTaskList.forEach(task => task());
        };

        // æ‰§è¡Œï¼Œå¼‚å¸¸ç”¨rejectå…¨å±€æ•èŽ·
        try {
            exector(resolve, reject);
        }
        catch(err) {
            reject(err);
        }
    }

    /**
     * thenå‡½æ•°ï¼ŒæŽ¥å—ä¸¤ä¸ªå‡½æ•°å‚æ•°
     * @params onFulfield resolveçš„æ‰§è¡Œå‡½æ•°ï¼Œå‡½æ•°æ‰§è¡ŒæˆåŠŸæ—¶è§¦å‘
     * @params onReject rejectçš„æ‰§è¡Œå‡½æ•°ï¼Œå‡½æ•°æ‰§è¡Œå¤±è´¥æ—¶è§¦å‘
     * @returns è¿”å›žä¸€ä¸ªMyPromiseï¼Œç”¨äºŽé“¾å¼è°ƒç”¨.then(xxx).then(xxx)...
    */
    then(onFulfield, onReject){
        const that = this;
        return new MyPromise((resolve, reject) => {
            // resolveå‡½æ•°çš„å†…éƒ¨åŒ…è£…ï¼Œå†…éƒ¨åšäº†ç±»åž‹å…¼å®¹å¤„ç†
            const fulfieldTask = () => {
                const x = onFulfield(that.value);
                x instanceof MyPromise
                    ? x.then(resolve, reject)
                    : resolve(x);
            };
            // rejectå‡½æ•°çš„å†…éƒ¨åŒ…è£…ï¼Œä¹Ÿåšäº†ç±»åž‹å…¼å®¹å¤„ç†
            const rejectTask = () => {
                const x = onReject(that.reason);
                x instanceof MyPromise
                    ? x.then(resolve, reject)
                    : reject(x);
            };
            // å¦‚æžœå‡½æ•°æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™å°†ä¸¤ä¸ªæ‰§è¡Œå‡½æ•°éƒ½è®¢é˜…èµ·æ¥
            if (that.status === that.PENDING) {
                that.resolveTaskList.push(fulfieldTask);
                that.reasonTaskList.push(rejectTask);
            }
            // å¦‚æžœæ‰§è¡ŒæˆåŠŸï¼Œåˆ™ç›´æŽ¥æ‰§è¡ŒåŒ…è£…å‡½æ•°å³å¯
            if (that.status === that.FULFIELD) {
                fulfieldTask();
            }
            // å¦‚æžœæ‰§è¡Œå¤±è´¥ï¼Œä¹Ÿç›´æŽ¥æ‰§è¡ŒåŒ…è£…å‡½æ•°
            if (that.status === that.REJECT) {
                rejectTask();
            }
        });
    }

    /**
     * catchå¼‚å¸¸æ•èŽ·å‡½æ•°ï¼ŒæŽ¥æ”¶ä¸€ä¸ªæ‰§è¡Œå‡½æ•°
     * @params fn å¼‚å¸¸æ‰§è¡Œå‡½æ•°ï¼Œè°ƒç”¨é“¾ä¸­å‘ç”Ÿå¼‚å¸¸æ—¶æ‰§è¡Œ
     * @returns MyPromiseå¯¹è±¡
    */
    catch(fn) {
        return this.then(null, fn);
    }

    /**
     * finallyå¿…æ‰§è¡Œçš„å‡½æ•°ï¼ŒæŽ¥å—ä¸€ä¸ªæ‰§è¡Œå‡½æ•°
     * @params fn æ‰§è¡Œå‡½æ•°ï¼Œæ— è®ºæ‰§è¡ŒæˆåŠŸå¤±è´¥éƒ½ä¼šå…ˆæ‰§è¡Œè¿™ä¸ªå¤„ç†
     * @returns MyPromseå¯¹è±¡
    */
    finally(fn) {
        return this.then(
            value => MyPromise.resolve(fn()).then(() => value),
            reason => MyPromise.resolve(fn()).then(() => {throw reason})
        );
    }

    /**
     * resolveé™æ€å‡½æ•°ï¼ŒæŽ¥æ”¶resolveçš„å€¼
     * @params value æ‰‹åŠ¨resolveçš„å€¼
     * @returns MyPromiseå¯¹è±¡
    */
    static resolve(value) {
        return new MyPromise(resolve => resolve(value));
    }

    /**
     * all å¹¶å‘æ‰§è¡Œå‡½æ•°ï¼Œæ”¯æŒMyPromiseçš„å¹¶å‘æ‰§è¡Œï¼Œå…¨æ‰§è¡Œå®Œæ¯•åŽè¿”å›ž
     * @params taskList MyPromiseæ‰§è¡Œåˆ—è¡¨
     * @returns MyPromiseå¯¹è±¡
    */
    static all(taskList = []) {
        return new MyPromise((resolve, reject) => {
            const result = [];
            let count = 0;
            taskList.forEach((task, index) => {
                if (!task instanceof MyPromise) {
                    result[index] = task;
                    count++;
                    if (count === taskList.length) {
                        resolve(result);
                    }
                }
                else {
                    task.then(res => {
                        result[index] = res;
                        count++;
                        if (count === taskList.length) {
                            resolve(result);
                        }
                    });
                }
            });
        });
    }

    /**
     * race å¹¶å‘æ‰§è¡Œå‡½æ•°ï¼Œæ”¯æŒMyPromiseå¹¶å‘æ‰§è¡Œï¼Œåªresolveæœ€å…ˆæ‰§è¡Œå®Œæ¯•çš„ä»»åŠ¡
     * @params taskList MyPromiseæ‰§è¡Œåˆ—è¡¨
     * @returns MyPromiseå¯¹è±¡
    */
    static race(taskList = []) {
        return new MyPromise((resolve, reject) => {
            let done = false;
            taskList.forEach(task => {
                task instanceof MyPromise
                    ? task.then(res => {
                        !done && resolve(res);
                        done = true;
                    })
                    : resolve(task);
            });
        });
    }

    // æ¨¡æ‹Ÿä½¿ç”¨åœºæ™¯å·ðŸ‘Œ
    const task1 = new MyPromise((resolve, reject) => {
        setTimeout(() => {
            resolve('p1');
        }, 1000);
    });
    const task2 = new MyPromise((resolve, reject) => {
        setTimeout(() => {
            resolve('p2');
        }, 500);
    });
    const task3 = new MyPromise((resolve, reject) => {
        setTimeout(() => {
            resolve('p3');
        }, 2000);
    });
    MyPromise.all([task1, task2, task3]).then(res => {
        console.log('res: ', res);
    });
}
```